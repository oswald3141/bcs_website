<script>  
  function str_to_clipboard(str) {    
    navigator.clipboard
      .writeText(str)
      .then(() => {})
      .catch(() => {
        alert("An error occured.");
      });
  }

  function download_str(filename, text) {
    let blob = new Blob([text], {type : "text/plain"});
    var link = document.createElement('a');
    link.href = window.URL.createObjectURL(blob);
    link.target = '_blank';
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  function return_key_to_user(name, standard, decoded) {
    var c = document.getElementById('awgKeyFormatCheckDecoded');
    if (c.checked) {
      download_str(name + '.conf', decoded);
    } else { 
      str_to_clipboard(standard);
    }
  }
  
  function change_keys_visibility() {
    let mainState =
      document.getElementById("keyTypeRadioMain").checked ? "" : "none";
    for (let el of document.getElementsByClassName("main-key-column"))
      el.style.display = mainState;
    let relayState =
      document.getElementById("keyTypeRadioRelay").checked ? "" : "none";
    for (let el of document.getElementsByClassName("relay-key-column"))
      el.style.display = relayState;
  }
  
  window.onload = change_keys_visibility;
</script>

<style>
  @media (max-width: 799px) {
    .desktop_table {
        display: none;
    }
  }
  
  @media (min-width: 800px) {
    .mobile_table {
        display: none;
    }
  }
</style>

<?php
  function get_awg_key_buttons($srv, $keys, $keyType) {
    $btns = "";

    if ($keyType == "main") {
      $btnType = "primary";
    } elseif ($keyType == "relay") {
      $btnType = "secondary";
    } else {
      return $btns;
    }

    foreach($keys as $i=>$key) {
      $name = $srv . "_" . (++$i) . "_" . $keyType;
      $key_enc = $key['encoded'];
      $key_nat = substr(json_encode($key['native']), 1, -1);
      if(empty($key_enc) and empty($key_nat)) {continue;};
      $btns .= 
        "<button class=\"btn mb-1 btn-{$btnType}\" onclick=
          \"return_key_to_user('{$name}', '{$key_enc}', '{$key_nat}')\">".$i."</button>". PHP_EOL;
    }

    if(empty($btns)) {
      $btns = "Ретрансляция не требуется";
    }

    return $btns;
  }

  function get_xray_key_button($srv, $key, $keyType) {
    $btn = "";

    if ($keyType == "main") {
      $btnType = "primary";
      $btn = "Протокол не поддерживается";
    } elseif ($keyType == "relay") {
      $btnType = "secondary";
      $btn = "Ретрансляция не требуется";
    } else {
      return $btn;
    }

    if(!empty($key)) {
        $name = $srv . "_" . $keyType;
        $key_enc = $key['encoded'];
        $key_nat = substr(json_encode($key['native'], 
          JSON_HEX_TAG|JSON_HEX_AMP|JSON_HEX_APOS|JSON_HEX_QUOT), 1, -1);
        $btn =
          "<button class=\"btn mb-1 btn-{$btnType}\" onclick=
            \"return_key_to_user('{$name}', '{$key_enc}', '{$key_nat}')\">Скопировать</button>". PHP_EOL;
    }

    return $btn;
  }
?>

<form method="POST" class="container-md text-end pt-3">
  <button class="btn btn-danger" name="logout">Выйти</button>
</form>

<div class="container-md text-center mb-2">
    <h1>Здравствуйте, <?php echo $FRONTEND_DATA['user_real_name'];?>!</h1>
    <p class="text-start">
      Вам предоставлен доступ к серверам, перечисленным ниже.<br>
      Нажмите на кнопку с нужным вам ключом в таблице,
      чтобы скопировать этот ключ в буфер обмена.<br>
      Пожалуйста, используйте ключи с пометкой "ретранслятор" 
      <b>только если вам их порекомендовал администратор серверов</b>.
    </p>
</div>

<div class="container-md text-start mb-2">
  <div class="form-check form-check-inline">
    <input
      class="form-check-input"
      type="radio"
      name="keyTypeRadioOptions"
      id="keyTypeRadioMain"
      value="main"
      onchange="change_keys_visibility()"
      checked
    >
    <label class="form-check-label" for="keyTypeRadioMain">
      Основные ключи
    </label>
  </div>
  <div class="form-check form-check-inline">
    <input
      class="form-check-input"
      type="radio"
      name="keyTypeRadioOptions"
      id="keyTypeRadioRelay"
      value="relay"
      onchange="change_keys_visibility()"
    >
    <label class="form-check-label" for="keyTypeRadioRelay">
      Ретрансляторы
    </label>
  </div>
  <div class="form-check form-check-inline">
    <input
      class="form-check-input"
      type="checkbox"
      id="awgKeyFormatCheckDecoded"
      value="decoded"
    >
    <label class="form-check-label" for="awgKeyFormatCheckDecoded">
      Расшифровать ключ
    </label>
  </div>
</div>

<div class="container-md text-center table-responsive desktop_table">
  <table class="table">
    <thead class="table-dark">
      <tr>
        <th scope="col" class="align-middle col-1">Сервер</th>
        <th scope="col" class="align-middle col-1">Расположение</th>
        <th scope="col" class="align-middle col-4">Описание</th>
        <th scope="col" class="align-middle col-3 main-key-column">
          Ключ AWG<br>(основной)
        </th>
        <th scope="col" class="align-middle col-3 main-key-column">
          Ключ XRay<br>(основной)
        </th>
        <th scope="col" class="align-middle col-3 relay-key-column">
          Ключ AWG<br>(ретранслятор)
        </th>
        <th scope="col" class="align-middle col-3 relay-key-column">
          Ключ XRay<br>(ретранслятор)
        </th>
      </tr>
    </thead>
    <tbody>
    <?php
      foreach($FRONTEND_DATA['access_srv_data'] as $srv) {
        $mainbtns_awg = get_awg_key_buttons(
          $srv['name'], array_column($srv['awg_keys'], 'main'), "main");
        $relaybtns_awg = get_awg_key_buttons(
          $srv['name'], array_column($srv['awg_keys'], 'relay'), "relay");

        $mainbtn_xray = get_xray_key_button(
          $srv['name'], is_null($srv['xray_keys']) ? '' : $srv['xray_keys'][0]['main'], "main");
        $relaybtn_xray = get_xray_key_button(
          $srv['name'], is_null($srv['xray_keys']) ? '' : $srv['xray_keys'][0]['relay'], "relay");

        echo ""
        ."<tr>" . PHP_EOL
          ."<th scope=\"row\"> {$srv['name']} </th>" . PHP_EOL
          ."<td> {$srv['location']} </td>" . PHP_EOL
          ."<td> {$srv['description']} </td>" . PHP_EOL
          ."<td class=\"main-key-column\"> {$mainbtns_awg} </td>" . PHP_EOL
          ."<td class=\"main-key-column\"> {$mainbtn_xray} </td>" . PHP_EOL
          ."<td class=\"relay-key-column\"> {$relaybtns_awg} </td>" . PHP_EOL
          ."<td class=\"relay-key-column\"> {$relaybtn_xray} </td>" . PHP_EOL
        ."</tr>" . PHP_EOL;
      }
    ?>
    </tbody>
  </table>
</div>

<div class="container-md text-center table-responsive mobile_table">
  <table class="table">
    <tbody>
    <?php
      foreach($FRONTEND_DATA['access_srv_data'] as $srv) {
        $mainbtns_awg = get_awg_key_buttons(
          $srv['name'], array_column($srv['awg_keys'], 'main'), "main");
        $relaybtns_awg = get_awg_key_buttons(
          $srv['name'], array_column($srv['awg_keys'], 'relay'), "relay");

        $mainbtn_xray = get_xray_key_button(
          $srv['name'], $srv['xray_keys'][0]['main'], "main");
        $relaybtn_xray = get_xray_key_button(
          $srv['name'], $srv['xray_keys'][0]['relay'], "relay");

        echo ""
        ."<tr>" . PHP_EOL
          ."<td>" . PHP_EOL
            ."<b>{$srv['name']}</b><br>" . PHP_EOL
            ."{$srv['location']}<br>" . PHP_EOL
            ."{$srv['description']}<br>" . PHP_EOL
            ."Кликните, чтобы скопировать ключ AWG:<br>" . PHP_EOL
            ."<div class=\"main-key-column\"> {$mainbtns_awg} </div>" . PHP_EOL
            ."<div class=\"relay-key-column\"> {$relaybtns_awg} </div>" .PHP_EOL
            ."Кликните, чтобы скопировать ключ XRay:<br>" . PHP_EOL
            ."<div class=\"main-key-column\"> {$mainbtn_xray} </div>" . PHP_EOL
            ."<div class=\"relay-key-column\"> {$relaybtn_xray} </div>" .PHP_EOL
          ."</td>" . PHP_EOL
        ."</tr>" . PHP_EOL;
      }
    ?>
    </tbody>
  </table>
</div>

<div class="container-md text-start mb-5">
  <h2>Как начать пользоваться?</h2>
  <ol>
    <li>
      Скачайте приложение Amnezia VPN <a href="https://storage.googleapis.com/kldscp/amnezia.org/ru/downloads" target="_blank"> по этой ссылке</a> и установите его.
    </li>
    <li>
      Скопируйте нужный вам ключ с этой страницы и добавьте его в приложение. Инструкцию по добавлению вы можете найти 
      <a href="https://storage.googleapis.com/kldscp/amnezia.org" target="_blank">на сайте Amnezia</a>.
      Для этого кликните на кнопку "Документация" вверху страницы, нажмите кнопку "Документация" на открывшейся странице и перейдите в раздел 
      "Подключение через ключ в виде текста" в меню слева.
    </li>
  </ol>
  <p>Вы можете добавить в приложение сразу несколько серверов и переключаться между ними по необходимости. Для этого воспользуйтесь кнопкой со значком "плюс" в 
  нижней части главного экрана приложения.</p>

  <h2>Как выбрать сервер?</h2>
  <ul style="list-style-type:disc;">
    <li>Если вы собираетесь скачивать торренты, используйте <b>только</b> сервер <i>Jimmy</i>.</li>
    <li>
      Если, наоборот, вы не планируете скачивать торренты, пожалуйста, избегайте использования этого сервера.
      Так вы не будете создавать на него лишнюю нагрузку и сохраните пропускную полосу сервера для тех, кому она нужнее.
    </li>
    <li>Избегайте использования сервера <i>Jimmy</i> на мобильных устройствах: крайне маловероятно, что вы будете скачивать с них торренты.</li>
    <li>Если расположение сервера вам не важно, выбирайте между серверами <i>Howard</i> и <i>Chuck</i> наугад.</li>
    <li>Сервер <i>Howard</i> расположен чуть ближе к европейской части России и, вероятно, обеспечит чуть меньшую задержку, чем <i>Chuck</i>.</li>
    <li>Но канал передачи данных у <i>Chuck</i> в три раза шире, чем у <i>Howard</i>.</li>
    <li>
      Используйте сервер <i>Caldera</i>, только если вы находитесь за рубежом и вам нужно получить доступ к 
      российским сайтам, доступ к которым с иностранных IP адресов ограничен. Помните, что в таком сценарии российским властям теоретически
      доступны доменные имена и IP адреса сайтов, которые вы посещаете.
    </li>
    <li>
      Используйте ретрансляторы, только если вам порекомендовал их администратор или если вы понимаете, зачем они нужны. Ретрансляцию обеспечивает
      сервер <i>Caldera</i>, но в этом сценарии весь трафик проходит через него в зашифрованном виде.
    </li>
  </ul> 

  <h2>Как выбрать протокол?</h2>
  <p>В целом, можно выбирать наугад. Теоретически, протокол AWG немного быстрее
  и может обеспечить меньшую задержку, а протокол XRay более устойчив к
  блокировкам.<br>
  На случай блокировок, рекомендуется добавить в приложение оба протокола для
  каждого сервера. Так, в случае, если один из протоколов окажется
  заблокирован, вы сможете воспользоваться другим.</p>

  <h2>Как пользоваться с нескольких устройств одновременно? (XRay)</h2>
  <p>Протокол XRay не подразумевает никаких ограничений на количество одновременных соединений. Вы можете использовать один и тот же ключ на всех своих устройствах.</p>
  
  <h2>Как пользоваться с нескольких устройств одновременно? (AWG)</h2>
  <p>Из-за технических особенностей протокола AWG, в любой момент времени каждый ключ может использоваться для подключения только с одного устройства. Это означает, что если два устройства
  используют один и тот же ключ, они не могут подключаться к VPN одновременно. Пожалуйста, используйте разные ключи
  на устройствах, которые вы хотите подключать к VPN одновременно.<br>
  <br>
  Для вашего удобства имя сервера в приложении Amnezia содержит номер использованного вами ключа.
  Например, если вы использовали  ключ №3 для подключения своего телефона к серверу Chuck,
  в приложении в качестве имени сервера будет отображаться "Chuck FI 3".<br>
  <br>
  <b>Обратите внимание:</b> ключи для каждого отдельного сервера <b>уникальны</b> и не повторяются. Это значит,
  что вам доступно по 5 одновременных подключений <i>к каждому серверу</i>, а не всего.<br>
  <br>
  Если вам нужно больше 5 одновременных подключений по протоколу AWG, пожалуйста, напишите мне, и я сгенерирую для вас дополнительные
  ключи. Объяснять, почему вам нужно больше 5 подключений, не потребуется.</p>

  <h2>Как переключаться между добавленными серверами?</h2>
  <ol>
    <li>Кликните на кнопку со значком "стрелка вниз" справа от названия выбранного сервера.</li>
    <li>Кликните на нужный вам сервер.</li>
    <li>Кликните на кнопку со значком "домик" в нижней части приложения.</li>
  </ol>
  <h2>Что такое раздельное туннелирование?</h2>
  <p>Раздельное туннелирование позволяет вам отправлять трафик выбранных сайтов или приложений в обход VPN. Это может быть удобно, если вы хотите, не отключая VPN, заходить
  на российские сайты, доступ к которым с зарубежных IP адресов ограничен.<br>
  Помните, что современные сайты могут использовать в своей работе множество разных доменов, поэтому настройка раздельного туннелирования сайтов может оказаться нетривиальной.
  Раздельное туннелирование приложений проще в настройке. Например, вы можете установить на свой компьютер второй браузер и заходить через него на российские сайты без
  необходимости отключать VPN, предварительно настроив для этого браузера раздельное туннелирование.<p>
  <h2>Для чего нужен переключатель "Расшифровать ключ"?</h2>
  <p>Если его включить, нажатие кнопки в столбце "Ключ AWG" или "Ключ XRay" вместо копирования ключа доступа для приложения AmneziaVPN будет скачивать расшифрованный "родной" конфигурационный файл соответствующего протокола. Такой файл пригоден для использования в приложении <a href="https://docs.amnezia.org/ru/documentation/amnezia-wg/" target="_blank">AmneziaWG</a>. Пожалуйста, не путайте это приложение с AmneziaVPN, которым вы, вероятнее всего, пользуетесь. Приложение AmneziaWG поддерживает только протокол AWG и не включает никаких дополнительных функций, в отличие от приложения AmneziaVPN, которое среди прочего поддерживает другие протоколы. Расшифрованный конфигурационный файл и приложение AmneziaWG могут вам понадобится для настройки VPN на устройствах Apple, так как приложение AmneziaVPN удалено из российского AppStore по требованию Роскомнадзора. Помимо этого, конфигурационный файл будет полезен при настройке VPN по протоколу AWG на роутерах.<p>
</div>
